
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .chat-header {
            background: #2563eb;
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        .message {
            margin: 0.5rem 0;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            max-width: 80%;
        }
        .message.user {
            background: #2563eb;
            color: white;
            margin-left: auto;
        }
        .message.assistant {
            background: #f3f4f6;
            color: #1f2937;
        }
        .input-container {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        .input-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            outline: none;
        }
        .input-container button {
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .input-container button:hover {
            background: #1d4ed8;
        }
        .typing {
            font-style: italic;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div id="chat-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function ChatWidget() {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            const sessionId = "{{SESSION_ID}}";
            let apiUrl = "{{API_URL}}";
            const isMobile = {{IS_MOBILE}};

            // Fix mixed content issues - use HTTPS if parent page is HTTPS
            if (window.location.protocol === 'https:' && apiUrl.startsWith('http:')) {
                apiUrl = apiUrl.replace('http:', 'https:');
            }

            useEffect(() => {
                loadMessages();
            }, []);

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const loadMessages = async () => {
                try {
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}`);
                    const data = await response.json();
                    setMessages(data);
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;

                const userMessage = { 
                    sender: 'user', 
                    content: inputValue,
                    messageType: 'text',
                    createdAt: new Date()
                };
                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                setIsTyping(true);

                try {
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: inputValue }),
                    });

                    const data = await response.json();
                    setMessages(prev => [...prev, data]);
                } catch (error) {
                    console.error('Error sending message:', error);
                    setMessages(prev => [...prev, { 
                        sender: 'bot', 
                        content: 'Sorry, I encountered an error. Please try again.',
                        messageType: 'text',
                        createdAt: new Date()
                    }]);
                } finally {
                    setIsTyping(false);
                }
            };

            const handleOptionSelect = async (optionId, payload) => {
                // Show user's selection first
                const userSelectionText = getOptionDisplayText(optionId);
                setMessages(prev => [...prev, {
                    sender: 'user',
                    content: userSelectionText,
                    messageType: 'text',
                    createdAt: new Date()
                }]);
                
                setIsTyping(true);

                try {
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}/select-option`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ optionId, payload }),
                    });

                    const data = await response.json();
                    setMessages(prev => [...prev, data.botMessage]);
                } catch (error) {
                    console.error('Error selecting option:', error);
                    setMessages(prev => [...prev, {
                        sender: 'bot',
                        content: 'Sorry, I encountered an error. Please try again.',
                        messageType: 'text',
                        createdAt: new Date()
                    }]);
                } finally {
                    setIsTyping(false);
                }
            };

            const getOptionDisplayText = (optionId) => {
                const optionTexts = {
                    billing: "I have a question about my billing",
                    technical: "I need technical support", 
                    sales: "I have a sales inquiry",
                    payment: "I have payment issues",
                    subscription: "I want to change my subscription",
                    invoice: "I need to download an invoice",
                    paymentIssues: "Payment Issues",
                    updatePaymentMethod: "Update Payment Method",
                    viewBilling: "View Billing History",
                    issue1: "My payment was declined",
                    issue2: "I was charged incorrectly",
                    issue3: "I need a refund"
                };
                return optionTexts[optionId] || "Selected option";
            };

            const handleQuickReply = async (reply) => {
                setInputValue('');
                setIsTyping(true);

                try {
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: reply }),
                    });

                    const data = await response.json();
                    setMessages(prev => [...prev, 
                        { sender: 'user', content: reply, messageType: 'text', createdAt: new Date() },
                        data
                    ]);
                } catch (error) {
                    console.error('Error sending quick reply:', error);
                } finally {
                    setIsTyping(false);
                }
            };

            const closeChat = () => {
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'CLOSE_CHAT' }, '*');
                }
            };

            const renderMessage = (message) => {
                if (message.messageType === 'card' && message.metadata) {
                    return React.createElement('div', { 
                        style: { 
                            background: 'white', 
                            borderRadius: '8px', 
                            border: '1px solid #e5e7eb', 
                            overflow: 'hidden',
                            marginBottom: '0.5rem'
                        }
                    }, [
                        message.metadata.imageUrl && React.createElement('img', {
                            key: 'image',
                            src: message.metadata.imageUrl,
                            alt: message.metadata.title || 'Card image',
                            style: { width: '100%', height: '128px', objectFit: 'cover' }
                        }),
                        React.createElement('div', { key: 'content', style: { padding: '12px' } }, [
                            message.metadata.title && React.createElement('h4', {
                                key: 'title',
                                style: { fontWeight: '600', marginBottom: '8px' }
                            }, message.metadata.title),
                            message.metadata.description && React.createElement('p', {
                                key: 'desc',
                                style: { fontSize: '14px', color: '#6b7280', marginBottom: '12px' }
                            }, message.metadata.description),
                            message.content && message.content !== message.metadata.title && React.createElement('p', {
                                key: 'content',
                                style: { marginBottom: '12px' }
                            }, message.content),
                            message.metadata.buttons && React.createElement('div', {
                                key: 'buttons',
                                style: { display: 'flex', flexDirection: 'column', gap: '8px' }
                            }, message.metadata.buttons.map((button, idx) => 
                                React.createElement('button', {
                                    key: idx,
                                    onClick: () => handleOptionSelect(button.id, button.payload),
                                    style: {
                                        padding: '8px 12px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '6px',
                                        background: 'white',
                                        cursor: 'pointer',
                                        textAlign: 'left'
                                    }
                                }, button.text)
                            ))
                        ])
                    ]);
                }

                if (message.messageType === 'menu' && message.metadata?.options) {
                    return React.createElement('div', {
                        style: {
                            background: 'white',
                            borderRadius: '8px',
                            border: '1px solid #e5e7eb',
                            padding: '12px',
                            marginBottom: '0.5rem'
                        }
                    }, [
                        React.createElement('p', { key: 'content', style: { marginBottom: '12px' } }, message.content),
                        React.createElement('div', { 
                            key: 'options',
                            style: { display: 'flex', flexDirection: 'column', gap: '8px' }
                        }, message.metadata.options.map((option, idx) =>
                            React.createElement('button', {
                                key: idx,
                                onClick: () => handleOptionSelect(option.id, option.payload),
                                style: {
                                    padding: '12px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    background: 'white',
                                    cursor: 'pointer',
                                    textAlign: 'left',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }
                            }, option.text)
                        ))
                    ]);
                }

                // Default text message with quick replies
                return React.createElement('div', {}, [
                    React.createElement('p', { key: 'content' }, message.content),
                    message.metadata?.quickReplies && React.createElement('div', {
                        key: 'quickReplies',
                        style: {
                            display: 'flex',
                            flexWrap: 'wrap',
                            gap: '8px',
                            marginTop: '8px'
                        }
                    }, message.metadata.quickReplies.map((reply, idx) =>
                        React.createElement('button', {
                            key: idx,
                            onClick: () => handleQuickReply(reply),
                            style: {
                                padding: '4px 12px',
                                background: '#f3f4f6',
                                border: 'none',
                                borderRadius: '16px',
                                fontSize: '14px',
                                cursor: 'pointer'
                            }
                        }, reply)
                    ))
                ]);
            };

            return (
                <div className="chat-container">
                    <div className="chat-header">
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                            <img 
                                src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&auto=format&fit=crop&w=256&h=256"
                                alt="Support"
                                style={{ width: '40px', height: '40px', borderRadius: '50%' }}
                            />
                            <div>
                                <h3 style={{ margin: 0, fontWeight: '600' }}>Support Assistant</h3>
                                <div style={{ fontSize: '0.75rem', opacity: 0.8 }}>
                                    <span style={{ display: 'inline-block', width: '8px', height: '8px', backgroundColor: '#10b981', borderRadius: '50%', marginRight: '4px' }}></span>
                                    Online
                                </div>
                            </div>
                        </div>
                        {isMobile ? (
                            React.createElement('button', {
                                onClick: closeChat,
                                style: { background: 'none', border: 'none', color: 'white', cursor: 'pointer', padding: '0.5rem' }
                            }, React.createElement('svg', {
                                width: '20',
                                height: '20',
                                fill: 'currentColor',
                                viewBox: '0 0 24 24'
                            }, React.createElement('path', {
                                d: 'M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'
                            })))
                        ) : (
                            React.createElement('button', {
                                onClick: closeChat,
                                style: { background: 'none', border: 'none', color: 'white', cursor: 'pointer', padding: '0.5rem' }
                            }, React.createElement('svg', {
                                width: '16',
                                height: '16',
                                fill: 'currentColor',
                                viewBox: '0 0 24 24'
                            }, React.createElement('path', {
                                d: 'M19 13H5v-2h14v2z'
                            })))
                        )}
                    </div>

                    <div className="chat-content">
                        {messages.length === 0 ? (
                            <div style={{ textAlign: 'center', color: '#6b7280', marginTop: '2rem' }}>
                                <p>👋 Hi! How can I help you today?</p>
                            </div>
                        ) : (
                            messages.map((message, index) => (
                                <div key={index} className={`message ${message.sender}`}>
                                    {renderMessage(message)}
                                </div>
                            ))
                        )}

                        {isTyping && (
                            <div className="message assistant typing">
                                Assistant is typing...
                            </div>
                        )}

                        <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={sendMessage} className="input-container">
                        <input
                            type="text"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            placeholder="Type your message..."
                            disabled={isTyping}
                        />
                        <button type="submit" disabled={isTyping}>
                            Send
                        </button>
                    </form>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('chat-root'));
        root.render(React.createElement(ChatWidget));
    </script>
</body>
</html>
