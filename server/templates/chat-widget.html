<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://unpkg.com/react@18/umd/react.development.js" as="script">
    <link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.development.js" as="script">
    <link rel="preload" href="https://unpkg.com/@babel/standalone/babel.min.js" as="script">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="components/chat-utils.js" as="script">
    <link rel="preload" href="components/home-tab.js" as="script">
    <link rel="preload" href="components/message-bubble.js" as="script">
    
    <!-- Load scripts in order -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="chat-root">
        <div class="chat-loading-skeleton">
            <!-- Header skeleton -->
            <div class="skeleton-header">
                <div class="skeleton-avatar"></div>
                <div class="skeleton-header-text">
                    <div class="skeleton-line skeleton-title"></div>
                    <div class="skeleton-line skeleton-status"></div>
                </div>
            </div>
            
            <!-- Content skeleton -->
            <div class="skeleton-content">
                <div class="skeleton-message bot">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble"></div>
                </div>
                <div class="skeleton-message user">
                    <div class="skeleton-bubble"></div>
                </div>
                <div class="skeleton-message bot">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble"></div>
                </div>
            </div>
            
            <!-- Input skeleton -->
            <div class="skeleton-input">
                <div class="skeleton-input-field"></div>
                <div class="skeleton-button"></div>
            </div>
            
            <!-- Tab navigation skeleton -->
            <div class="skeleton-tabs">
                <div class="skeleton-tab active"></div>
                <div class="skeleton-tab"></div>
            </div>
        </div>
        
        <style>
            .chat-loading-skeleton {
                width: 100%;
                height: 100vh;
                background: white;
                font-family: system-ui, -apple-system, sans-serif;
                display: flex;
                flex-direction: column;
            }
            
            .skeleton-header {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: #2563eb;
                color: white;
            }
            
            .skeleton-avatar {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: rgba(255,255,255,0.3);
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            .skeleton-header-text {
                flex: 1;
            }
            
            .skeleton-line {
                height: 12px;
                background: rgba(255,255,255,0.3);
                border-radius: 6px;
                margin-bottom: 4px;
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            .skeleton-title {
                width: 120px;
            }
            
            .skeleton-status {
                width: 60px;
                height: 8px;
            }
            
            .skeleton-content {
                flex: 1;
                padding: 16px;
                overflow: hidden;
            }
            
            .skeleton-message {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                margin-bottom: 16px;
            }
            
            .skeleton-message.user {
                justify-content: flex-end;
            }
            
            .skeleton-message.user .skeleton-avatar {
                display: none;
            }
            
            .skeleton-bubble {
                height: 40px;
                background: #f3f4f6;
                border-radius: 12px;
                animation: pulse 1.5s ease-in-out infinite;
                max-width: 250px;
            }
            
            .skeleton-message.bot .skeleton-bubble {
                width: 200px;
            }
            
            .skeleton-message.user .skeleton-bubble {
                width: 120px;
                background: #e5e7eb;
            }
            
            .skeleton-input {
                display: flex;
                gap: 8px;
                padding: 16px;
                border-top: 1px solid #e5e7eb;
            }
            
            .skeleton-input-field {
                flex: 1;
                height: 40px;
                background: #f3f4f6;
                border-radius: 8px;
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            .skeleton-button {
                width: 60px;
                height: 40px;
                background: #e5e7eb;
                border-radius: 8px;
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            .skeleton-tabs {
                display: flex;
                border-top: 1px solid #e5e7eb;
            }
            
            .skeleton-tab {
                flex: 1;
                height: 48px;
                background: #f9fafb;
                animation: pulse 1.5s ease-in-out infinite;
            }
            
            .skeleton-tab.active {
                background: #f3f4f6;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }
        </style>
    </div>

    <!-- Load utility functions -->
    <script src="components/chat-utils.js"></script>

    <!-- Load component modules -->
    <script type="text/babel" src="components/home-tab.js"></script>
    <script type="text/babel" src="components/message-bubble.js"></script>

    <script type="text/babel">
        // Wait for all dependencies to load before initializing
        function waitForDependencies() {
            return new Promise((resolve) => {
                const checkDependencies = () => {
                    if (typeof React !== 'undefined' && 
                        typeof ReactDOM !== 'undefined' && 
                        typeof Babel !== 'undefined' &&
                        window.HomeTab &&
                        window.MessageBubble &&
                        window.groupMessages) {
                        resolve();
                    } else {
                        setTimeout(checkDependencies, 50);
                    }
                };
                checkDependencies();
            });
        }

        // Add error handling
        window.addEventListener('error', function(e) {
            console.error('Chat Widget Error:', e.error);
        });

        // Initialize chat widget only after all dependencies are loaded
        waitForDependencies().then(() => {
            initializeChatWidget();
        }).catch(() => {
            console.error('Failed to load chat widget dependencies');
            document.getElementById('chat-root').innerHTML = '<div style="padding: 20px; text-align: center;">Error loading chat widget</div>';
        });

        function initializeChatWidget() {
            // Check if React is loaded
            if (typeof React === 'undefined') {
                console.error('React is not loaded');
                document.getElementById('chat-root').innerHTML = '<div style="padding: 20px; text-align: center;">Error loading chat widget</div>';
                return;
            }

        const { useState, useEffect, useRef } = React;

        // Main Chat Widget Component
        function ChatWidget() {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [isStreaming, setIsStreaming] = useState(false);
            const [activeTab, setActiveTab] = useState('home');
            const messagesEndRef = useRef(null);

            const sessionId = "{{SESSION_ID}}";
            let apiUrl = "{{API_URL}}";
            const isMobile = {{IS_MOBILE}};

            // Fix mixed content issues
            if (window.location.protocol === 'https:' && apiUrl.startsWith('http:')) {
                apiUrl = apiUrl.replace('http:', 'https:');
            }

            useEffect(() => {
                console.log('ChatWidget mounted with sessionId:', sessionId);
                loadMessages();
            }, []);

            useEffect(() => {
                scrollToBottom();
            }, [messages, isTyping]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const loadMessages = async () => {
                try {
                    console.log('Loading messages from:', `${apiUrl}/api/chat/${sessionId}`);
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('Loaded messages:', data);
                    // Handle both direct array and object with messages property
                    const messages = Array.isArray(data) ? data : (data.messages || []);
                    setMessages(messages);
                } catch (error) {
                    console.error('Error loading messages:', error);
                    // Add a user-visible error message
                    setMessages([{
                        sender: 'bot',
                        content: 'Sorry, there was an error loading the chat. Please try refreshing the page.',
                        messageType: 'text',
                        createdAt: new Date().toISOString(),
                        metadata: {}
                    }]);
                }
            };

            const addMessage = (message) => {
                setMessages(prev => [...prev, message]);
            };

            const sendStreamingMessage = async (message) => {
                const userMessage = { 
                    sender: 'user', 
                    content: message,
                    messageType: 'text',
                    createdAt: new Date().toISOString(),
                    metadata: {}
                };
                addMessage(userMessage);
                setInputValue('');
                setIsStreaming(true);
                setIsTyping(true);

                try {
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}/messages/stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: message }),
                    });

                    if (!response.body) {
                        throw new Error('No response body');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));

                                    if (data.type === 'bubble' && data.message) {
                                        addMessage(data.message);
                                        // Keep typing indicator active while more bubbles are coming
                                    } else if (data.type === 'complete') {
                                        setIsTyping(false);
                                        setIsStreaming(false);
                                        break;
                                    } else if (data.type === 'error') {
                                        setIsTyping(false);
                                        setIsStreaming(false);
                                        addMessage({
                                            sender: 'bot',
                                            content: data.message,
                                            messageType: 'text',
                                            createdAt: new Date().toISOString(),
                                            metadata: {}
                                        });
                                        break;
                                    } else if (data.type === 'end') {
                                        setIsTyping(false);
                                        setIsStreaming(false);
                                        break;
                                    }
                                } catch (parseError) {
                                    console.warn('Failed to parse streaming data:', parseError);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in streaming:', error);
                    setIsTyping(false);
                    setIsStreaming(false);
                    addMessage({
                        sender: 'bot',
                        content: 'Sorry, I encountered an error. Please try again.',
                        messageType: 'text',
                        createdAt: new Date().toISOString(),
                        metadata: {}
                    });
                } finally {
                    // Ensure typing indicator is always turned off when streaming ends
                    setIsTyping(false);
                    setIsStreaming(false);
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || isStreaming) return;

                const message = inputValue.trim();
                setActiveTab('chat');
                await sendStreamingMessage(message);
            };

            const handleOptionSelect = async (optionId, payload, optionText) => {
                if (isStreaming) return;

                const displayText = optionText || getOptionDisplayText(optionId);
                addMessage({
                    content: displayText,
                    sender: 'user',
                    messageType: 'text',
                    createdAt: new Date().toISOString(),
                    metadata: {}
                });

                setIsTyping(true);

                try {
                    const response = await fetch(`${apiUrl}/api/chat/${sessionId}/select-option`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ optionId, payload, optionText })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.allMessages && data.allMessages.length > 0) {
                            data.allMessages.forEach(message => addMessage(message));
                        } else if (data.botMessage) {
                            addMessage(data.botMessage);
                        }
                    }
                } catch (error) {
                    console.error('Error selecting option:', error);
                    addMessage({
                        content: 'Sorry, there was an error processing your selection.',
                        sender: 'bot',
                        messageType: 'text',
                        createdAt: new Date().toISOString(),
                        metadata: {}
                    });
                } finally {
                    setIsTyping(false);
                }
            };

            const handleQuickReply = async (reply) => {
                if (isStreaming) return;
                setActiveTab('chat');
                await sendStreamingMessage(reply);
            };

            const handleStartChat = async (topic, message) => {
                setActiveTab('chat');
                if (message) {
                    setTimeout(() => {
                        sendStreamingMessage(message);
                    }, 100);
                }
            };

            const closeChat = () => {
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'CLOSE_CHAT' }, '*');
                }
            };

            const messageGroups = groupMessages(messages);

            return (
                <div className="chat-container">
                    <div className="chat-header">
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                            <img 
                                src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&auto=format&fit=crop&w=256&h=256"
                                alt="Support"
                                style={{ width: '28px', height: '28px', borderRadius: '50%' }}
                            />
                            <div>
                                <h3 style={{ margin: 0, fontWeight: '600' }}>Support Assistant</h3>
                                <div style={{ fontSize: '0.75rem', opacity: 0.8 }}>
                                    <span style={{ display: 'inline-block', width: '8px', height: '8px', backgroundColor: '#10b981', borderRadius: '50%', marginRight: '4px' }}></span>
                                    Online
                                </div>
                            </div>
                        </div>
                        <button onClick={closeChat} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', padding: '0.5rem' }}>
                            {isMobile ? (
                                React.createElement('svg', { width: '20', height: '20', fill: 'currentColor', viewBox: '0 0 24 24' }, 
                                    React.createElement('path', { d: 'M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z' })
                                )
                            ) : (
                                React.createElement('svg', { width: '16', height: '16', fill: 'currentColor', viewBox: '0 0 24 24' }, 
                                    React.createElement('path', { d: 'M19 13H5v-2h14v2z' })
                                )
                            )}
                        </button>
                    </div>

                    {/* Home Tab Content */}
                    <div className={`tab-content ${activeTab !== 'home' ? 'hidden' : ''}`}>
                        <HomeTab onStartChat={handleStartChat} isMobile={isMobile} />
                    </div>

                    {/* Chat Tab Content */}
                    <div className={`tab-content ${activeTab !== 'chat' ? 'hidden' : ''}`}>
                        <div className="chat-content">
                            {messageGroups.length === 0 ? (
                                <div className="empty-state">
                                    <div style={{ fontSize: '48px', marginBottom: '1rem' }}>ðŸ’¬</div>
                                    <h3 style={{ fontWeight: '500', marginBottom: '0.5rem' }}>No messages yet</h3>
                                    <p style={{ fontSize: '14px' }}>Start a conversation or go to Home to choose a topic</p>
                                </div>
                            ) : (
                                messageGroups.map((group, groupIndex) => (
                                    React.createElement('div', {
                                        key: groupIndex,
                                        className: `message-group ${group.sender}`
                                    }, [
                                        group.sender === 'bot' && React.createElement('img', {
                                            key: 'avatar',
                                            src: "https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&auto=format&fit=crop&w=256&h=256",
                                            alt: "Bot avatar",
                                            className: "avatar"
                                        }),
                                        React.createElement('div', {
                                            key: 'messages',
                                            className: 'messages'
                                        }, [
                                            ...group.messages.map((message, messageIndex) => (
                                                React.createElement(MessageBubble, {
                                                    key: `${groupIndex}-${messageIndex}`,
                                                    message: message,
                                                    onOptionSelect: handleOptionSelect,
                                                    onQuickReply: handleQuickReply
                                                })
                                            )),
                                            React.createElement('div', {
                                                key: 'timestamp',
                                                className: 'timestamp'
                                            }, formatTimeAgo(group.timestamp))
                                        ])
                                    ])
                                ))
                            )}

                            {isTyping && (
                                <div className="message-group bot">
                                    <img 
                                        src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&auto=format&fit=crop&w=256&h=256"
                                        alt="Bot avatar"
                                        className="avatar"
                                    />
                                    <div className="messages">
                                        <div className="typing-indicator">
                                            <div className="typing-dot"></div>
                                            <div className="typing-dot"></div>
                                            <div className="typing-dot"></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div ref={messagesEndRef} />
                        </div>

                        <form onSubmit={sendMessage} className="input-container">
                            <input
                                type="text"
                                value={inputValue}
                                onChange={(e) => setInputValue(e.target.value)}
                                placeholder="Type your message..."
                                disabled={isStreaming}
                            />
                            <button type="submit" disabled={isStreaming}>
                                Send
                            </button>
                        </form>

                        <div className="quick-replies">
                            <button 
                                className="quick-reply"
                                onClick={() => handleQuickReply("Thank you")}
                                disabled={isStreaming}
                            >
                                Thank you
                            </button>
                            <button 
                                className="quick-reply"
                                onClick={() => handleQuickReply("I need more help")}
                                disabled={isStreaming}
                            >
                                I need more help
                            </button>
                            <button 
                                className="quick-reply"
                                onClick={() => handleQuickReply("Contact human agent")}
                                disabled={isStreaming}
                            >
                                Contact agent
                            </button>
                        </div>
                    </div>

                    {/* Tab Navigation */}
                    <div className="tab-navigation">
                        <button 
                            className={`tab-button ${activeTab === 'home' ? 'active' : ''}`}
                            onClick={() => setActiveTab('home')}
                        >
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                            </svg>
                            {!isMobile && <span>Home</span>}
                        </button>
                        <button 
                            className={`tab-button ${activeTab === 'chat' ? 'active' : ''}`}
                            onClick={() => setActiveTab('chat')}
                        >
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            </svg>
                            {!isMobile && <span>Chat</span>}
                            {messages.length > 0 && (
                                <span className="tab-badge">
                                    {messages.length}
                                </span>
                            )}
                        </button>
                    </div>
                </div>
            );
        }

        try {
                const root = ReactDOM.createRoot(document.getElementById('chat-root'));
                root.render(React.createElement(ChatWidget));
            } catch (error) {
                console.error('Error rendering ChatWidget:', error);
                document.getElementById('chat-root').innerHTML = `
                    <div style="padding: 20px; text-align: center; font-family: system-ui;">
                        <h3>Chat Widget Error</h3>
                        <p>Unable to load chat interface. Please refresh the page.</p>
                        <button onclick="window.location.reload()" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh</button>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>